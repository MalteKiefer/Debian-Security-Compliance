# Apache HTTP Server Security Configuration
# Debian Optimized - Enterprise Grade
# Mitigates CVE-2024-39884, CVE-2024-40725, CVE-2024-40898
# Compliance: CIS Level 1/2, ISO 27001, SOC 2, BSI Grundschutz

# Server Information Disclosure Protection
ServerTokens Prod
ServerSignature Off

# Security Headers Module (requires mod_headers)
<IfModule mod_headers.c>
    # Prevent clickjacking attacks
    Header always append X-Frame-Options SAMEORIGIN
    
    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Content Type Sniffing Protection  
    Header always set X-Content-Type-Options nosniff
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (adjust for your application)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self'; object-src 'none'; media-src 'self'; frame-src 'none'; worker-src 'none'; frame-ancestors 'none';"
    
    # HTTP Strict Transport Security (HSTS) - Enable only with HTTPS
    # Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    
    # Remove server information from headers
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# Disable unnecessary modules
<IfModule mod_autoindex.c>
    # Disable directory browsing
    Options -Indexes
</IfModule>

<IfModule mod_info.c>
    # Restrict server info access
    <Location "/server-info">
        SetHandler server-info
        Require local
        Require ip 127.0.0.1
    </Location>
</IfModule>

<IfModule mod_status.c>
    # Restrict server status access
    <Location "/server-status">
        SetHandler server-status
        Require local
        Require ip 127.0.0.1
    </Location>
</IfModule>

# File Access Control
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.(bak|backup|old|orig|save|swp|tmp)$">
    Require all denied
</FilesMatch>

<FilesMatch "\.(conf|log|ini)$">
    Require all denied
</FilesMatch>

# Protect sensitive directories
<DirectoryMatch "/\.git">
    Require all denied
</DirectoryMatch>

<DirectoryMatch "/\.svn">
    Require all denied
</DirectoryMatch>

# Request Size Limits (DoS Protection)
LimitRequestBody 10485760  # 10MB
LimitRequestFields 100
LimitRequestFieldSize 1024
LimitRequestLine 4096

# Timeout Configuration
Timeout 60
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# SSL/TLS Configuration (mod_ssl required)
<IfModule mod_ssl.c>
    # Disable SSL 2.0 and 3.0, enable only TLS 1.2+
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    
    # Strong cipher suites
    SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    SSLHonorCipherOrder On
    
    # Disable compression (CRIME attack mitigation)
    SSLCompression Off
    
    # Enable OCSP Stapling
    SSLUseStapling On
    SSLStaplingCache shmcb:/var/lib/apache2/ssl_stapling(32768)
    
    # Session cache
    SSLSessionCache shmcb:/var/lib/apache2/ssl_scache(512000)
    SSLSessionCacheTimeout 300
    
    # Disable insecure renegotiation
    SSLInsecureRenegotiation off
</IfModule>

# ModSecurity Configuration (if installed)
<IfModule mod_security2.c>
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyInMemoryLimit 131072
    SecRequestBodyLimitAction Reject
    SecDefaultAction "phase:1,log,auditlog,pass"
    SecDefaultAction "phase:2,log,auditlog,pass"
</IfModule>

# Evasive Module (DoS Protection)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        2
    DOSSiteCount        50  
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    DOSLogDir           /var/log/apache2
    DOSEmailNotify      admin@localhost
</IfModule>

# Request Filtering (mod_rewrite required)
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Block SQL injection attempts
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (\;|\'|\"|%22).*(union|select|insert|drop|delete|xp_|sp_) [NC,OR]
    RewriteCond %{QUERY_STRING} (sp_executesql) [NC]
    RewriteRule .* - [F,L]
    
    # Block XSS attempts
    RewriteCond %{QUERY_STRING} (\<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C)([^e]*e)+mbed.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C)([^o]*o)+bject.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C)([^i]*i)+frame.*(>|%3E) [NC]
    RewriteRule .* - [F,L]
    
    # Block directory traversal
    RewriteCond %{THE_REQUEST} \s/+(.*)/+\s [NC]
    RewriteRule ^ /%1 [R=301,L]
    RewriteCond %{REQUEST_URI} ^(.*)//(.*)$
    RewriteRule . %1/%2 [R=301,L]
</IfModule>

# LogFormat for security monitoring
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" combined_security
LogFormat "%{X-Forwarded-For}i %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" combined_proxy

# Error Page Customization (prevent information disclosure)
ErrorDocument 400 "Bad Request"
ErrorDocument 401 "Unauthorized"
ErrorDocument 403 "Forbidden"
ErrorDocument 404 "Not Found"
ErrorDocument 405 "Method Not Allowed"
ErrorDocument 500 "Internal Server Error"
ErrorDocument 502 "Bad Gateway"
ErrorDocument 503 "Service Unavailable"

# Trace Method Disable (CVE mitigation)
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} ^TRACE
    RewriteRule .* - [F]
</IfModule>

# Version-specific security patches (CVE-2024-40725 mitigation)
<IfModule mod_proxy.c>
    # Disable proxy functionality if not needed
    ProxyRequests Off
    ProxyPreserveHost On
    
    # If proxy is required, use strict validation
    ProxyBadHeader IsError
    ProxyTimeout 30
</IfModule>

# Additional File Type Restrictions
<FilesMatch "\.(php|pl|py|jsp|asp|sh|cgi)$">
    # Ensure scripts are only executed from allowed directories
    <RequireAll>
        Require all denied
    </RequireAll>
</FilesMatch>

# Content-Type handling (CVE-2024-39884 mitigation)
<IfModule mod_mime.c>
    # Ensure proper content type handling
    AddType application/x-httpd-php .php
    
    # Prevent execution of uploaded files
    <FilesMatch "\.php$">
        <If "%{REQUEST_URI} =~ m#^/uploads/#">
            SetHandler none
            ForceType text/plain
        </If>
    </FilesMatch>
</IfModule>

# Rate Limiting (if mod_evasive not available)
<IfModule mod_reqtimeout.c>
    RequestReadTimeout header=20-40,MinRate=500 body=20,MinRate=500
</IfModule>