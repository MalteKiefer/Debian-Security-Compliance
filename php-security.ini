; PHP Security Configuration
; Debian Optimized - Enterprise Grade
; Mitigates CVE-2024-4577 and general PHP security issues
; Compliance: CIS Level 1/2, ISO 27001, SOC 2, BSI Grundschutz
; Version: Compatible with PHP 8.1+, 8.2+, 8.3+ (patched versions)

; ===================================================================
; GENERAL SECURITY SETTINGS
; ===================================================================

; Disable dangerous functions
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source,file_get_contents,file_put_contents,fwrite,fputs,fopen,fclose,readfile,highlight_file,leak,apache_child_terminate,posix_kill,posix_mkfifo,posix_setpgid,posix_setsid,posix_setuid,proc_close,proc_get_status,proc_nice,proc_terminate,escapeshellarg,escapeshellcmd

; Disable dangerous classes
disable_classes = 

; Restrict PHP information disclosure
expose_php = Off
display_errors = Off
display_startup_errors = Off
log_errors = On

; Error reporting (log all errors but don't display them)
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT

; Set custom error log location
error_log = /var/log/php/error.log

; ===================================================================
; FILE SYSTEM SECURITY
; ===================================================================

; Restrict file operations to specific directory
open_basedir = "/var/www/html:/tmp:/var/tmp:/var/log/php"

; Disable remote file inclusion
allow_url_fopen = Off
allow_url_include = Off

; Restrict file uploads
file_uploads = On
upload_max_filesize = 10M
max_file_uploads = 20

; Temporary file directory
upload_tmp_dir = /tmp/php_uploads
sys_temp_dir = /tmp

; Maximum execution time (prevent infinite loops)
max_execution_time = 30
max_input_time = 30

; Memory limits
memory_limit = 128M

; ===================================================================
; SESSION SECURITY
; ===================================================================

; Secure session configuration
session.cookie_httponly = 1
session.cookie_secure = 1
session.cookie_samesite = "Strict"
session.use_only_cookies = 1
session.use_strict_mode = 1
session.use_trans_sid = 0

; Strong session ID generation
session.entropy_length = 32
session.hash_function = sha256
session.hash_bits_per_character = 6

; Session lifetime
session.gc_maxlifetime = 1440
session.cache_expire = 180
session.cookie_lifetime = 0

; Session storage security
session.save_path = "/var/lib/php/sessions"
session.name = "PHPSESSID_SECURE"

; ===================================================================
; INPUT DATA SECURITY
; ===================================================================

; Limit input data size
post_max_size = 16M
max_input_vars = 1000
max_input_nesting_level = 64

; SQL injection protection
; Magic quotes are deprecated, use prepared statements instead
magic_quotes_gpc = Off
magic_quotes_runtime = Off
magic_quotes_sybase = Off

; Register globals security (should always be off)
register_globals = Off

; ===================================================================
; OUTPUT SECURITY
; ===================================================================

; Output buffering
output_buffering = 4096

; Character encoding
default_charset = "UTF-8"

; Content type
default_mimetype = "text/html"

; ===================================================================
; RESOURCE LIMITS
; ===================================================================

; Prevent resource exhaustion attacks
max_execution_time = 30
max_input_time = 30
memory_limit = 128M
post_max_size = 16M

; Connection handling
ignore_user_abort = Off
default_socket_timeout = 60

; ===================================================================
; LOGGING AND MONITORING
; ===================================================================

; Enable logging
log_errors = On
log_errors_max_len = 1024
ignore_repeated_errors = On
ignore_repeated_source = Off
report_memleaks = On

; Log file location
error_log = /var/log/php/error.log

; Custom error handler for security events
; auto_prepend_file = "/var/www/security/error_handler.php"

; ===================================================================
; CGI SPECIFIC SECURITY (CVE-2024-4577 mitigation)
; ===================================================================

; Force CGI redirect (if using CGI)
cgi.force_redirect = 1
cgi.fix_pathinfo = 0

; Disable CGI path info (security risk)
cgi.discard_path = 1

; Restrict CGI binary path
; cgi.check_shebang_line = 1

; ===================================================================
; MAIL SECURITY
; ===================================================================

; SMTP configuration for security
SMTP = localhost
smtp_port = 25
sendmail_from = noreply@localhost

; Restrict mail functions if not needed
; disable_functions = mail

; ===================================================================
; DATABASE SECURITY
; ===================================================================

; MySQL settings
mysql.default_host = localhost
mysql.default_user = 
mysql.default_password = 
mysql.connect_timeout = 60
mysql.trace_mode = Off

; PostgreSQL settings  
pgsql.auto_reset_persistent = Off
pgsql.ignore_notice = 0
pgsql.log_notice = 0

; ===================================================================
; OPCACHE SECURITY
; ===================================================================

; OPcache settings for performance and security
opcache.enable = 1
opcache.enable_cli = 0
opcache.memory_consumption = 128
opcache.interned_strings_buffer = 8
opcache.max_accelerated_files = 10000
opcache.revalidate_freq = 2
opcache.validate_timestamps = 1

; Security: Prevent unauthorized access to OPcache
opcache.restrict_api = "/var/www/html"

; Protection against cache pollution
opcache.protect_memory = 1
opcache.save_comments = 0
opcache.enable_file_override = 0

; ===================================================================
; EXTENSION SPECIFIC SECURITY
; ===================================================================

; cURL security (if enabled)
; curl.cainfo = "/etc/ssl/certs/ca-certificates.crt"

; OpenSSL settings
; openssl.cafile = "/etc/ssl/certs/ca-certificates.crt"
; openssl.capath = "/etc/ssl/certs"

; Date/time settings
date.timezone = "UTC"

; ===================================================================
; ADDITIONAL SECURITY HEADERS (via PHP)
; ===================================================================

; Note: These headers should preferably be set by the web server
; but can be set here as a fallback

; Security headers (uncomment if not set by web server)
; auto_prepend_file = "/var/www/security/headers.php"

; Example headers.php content:
; <?php
; header('X-Frame-Options: SAMEORIGIN');
; header('X-XSS-Protection: 1; mode=block');
; header('X-Content-Type-Options: nosniff');
; header('Referrer-Policy: strict-origin-when-cross-origin');
; header('Content-Security-Policy: default-src \'self\'');
; ?>

; ===================================================================
; DEBUGGING AND DEVELOPMENT (DISABLE IN PRODUCTION)
; ===================================================================

; Development settings - DISABLE IN PRODUCTION
html_errors = Off
xmlrpc_errors = Off
xmlrpc_error_number = 0

; Disable dangerous development features
allow_webdav_methods = Off
auto_globals_jit = On

; ===================================================================
; SPECIFIC CVE MITIGATIONS
; ===================================================================

; CVE-2024-4577: PHP-CGI Argument Injection
; Ensure PHP is updated to 8.1.29+, 8.2.20+, or 8.3.8+
; Disable CGI if not needed, use FPM instead

; Additional Windows-specific hardening (if applicable)
; For Windows systems, ensure proper character encoding handling

; ===================================================================
; HARDENING CHECKLIST
; ===================================================================

; 1. Update PHP to latest patched version (8.1.29+, 8.2.20+, 8.3.8+)
; 2. Disable unnecessary extensions in php.ini
; 3. Set appropriate file permissions:
;    - chmod 644 /etc/php/*/fpm/php.ini
;    - chmod 644 /etc/php/*/cli/php.ini
;    - chmod 755 /var/lib/php/sessions
; 4. Configure log rotation for PHP error logs
; 5. Use PHP-FPM instead of mod_php or CGI when possible
; 6. Enable and configure fail2ban for PHP attack patterns
; 7. Regular security updates: apt update && apt upgrade php*
; 8. Use prepared statements for all database queries
; 9. Validate and sanitize all user input
; 10. Implement proper authentication and session management

; ===================================================================
; PHP-FPM SPECIFIC SECURITY SETTINGS
; ===================================================================

; Add to php-fpm pool configuration (/etc/php/*/fpm/pool.d/www.conf):
; 
; [www]
; user = www-data
; group = www-data
; 
; ; Security: Run each pool in separate chroot
; chroot = /var/www/html
; chdir = /
; 
; ; Process management
; pm = dynamic
; pm.max_children = 50
; pm.start_servers = 5
; pm.min_spare_servers = 5
; pm.max_spare_servers = 35
; pm.max_requests = 500
; 
; ; Security limits
; rlimit_files = 1024
; rlimit_core = 0
; 
; ; Access log
; access.log = /var/log/php/access.log
; access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"
; 
; ; Slow log
; slowlog = /var/log/php/slow.log
; request_slowlog_timeout = 10s
; 
; ; Security environment
; clear_env = yes
; env[HOSTNAME] = $HOSTNAME
; env[PATH] = /usr/local/bin:/usr/bin:/bin
; env[TMP] = /tmp
; env[TMPDIR] = /tmp
; env[TEMP] = /tmp

; ===================================================================
; MONITORING AND ALERTING
; ===================================================================

; Set up log monitoring for:
; - PHP errors and warnings
; - Failed file operations
; - Security-related events
; - Resource exhaustion
; 
; Example logrotate configuration for /etc/logrotate.d/php:
; /var/log/php/*.log {
;     daily
;     missingok
;     rotate 52
;     compress
;     delaycompress
;     notifempty
;     create 644 www-data adm
;     postrotate
;         /usr/sbin/service php8.1-fpm reload > /dev/null 2>&1 || true
;     endscript
; }